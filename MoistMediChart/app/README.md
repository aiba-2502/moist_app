# JSONデータ受信・管理システム（初学者向けガイド）

## 1. アプリケーションの概要
患者データと料金データを受け取り、それぞれ別々のJSONファイルとして保存します。
また、操作ログを記録し、Webインターフェースで確認できます。

### 主な機能
- 患者データと料金データの受信と保存
- データの分類と整理（患者情報と料金情報を分離）
- システムログの記録と表示
- Webインターフェースでのデータ確認

## 2. アプリケーションの動作フロー

1. **サーバー起動時**
   - 必要なディレクトリの作成確認
   - Webサーバーの起動（ポート3000）
   - 起動ログの記録

2. **データ受信時**
   - JSONデータを受信
   - データを患者情報と料金情報に分離
   - タイムスタンプ付きのファイル名で保存
   - 処理結果をログに記録

3. **データ表示時**
   - 最新データの表示
   - システムログの表示
   - 5秒ごとの自動更新

## 3. フォルダ構成

```
src/
├── lib/              # 共通ライブラリ
│   ├── errorHandler.js  # エラー処理
│   ├── logger.js       # ログ機能
│   └── server.js       # サーバー設定
├── routes/           # ルーティング（URLと処理の対応付け）
│   ├── dataRoutes.js   # データ関連のURL処理
│   └── logRoutes.js    # ログ関連のURL処理
├── services/         # ビジネスロジック
│   ├── dataService.js  # データ処理
│   ├── fileService.js  # ファイル操作
│   └── logService.js   # ログ処理
└── main.js          # アプリケーション起動

config/              # 設定ファイル
├── constants.js     # 定数定義
└── paths.js         # パス設定

public/             # 静的ファイル
├── index.html      # Webページ
├── styles.css      # スタイル設定
└── script.js       # フロントエンド処理
```

## 4. 各ファイルの役割

### メインファイル
- **main.js**: アプリケーションのエントリーポイント。サーバーを起動します。

### 共通ライブラリ（lib/）
- **server.js**: Expressサーバーの設定と起動を管理
- **logger.js**: ログの書き込みと読み取りを担当
- **errorHandler.js**: エラー処理の共通機能を提供

### ルーティング（routes/）
- **dataRoutes.js**: データの受信・取得APIを定義
- **logRoutes.js**: ログ取得APIを定義

### サービス（services/）
- **dataService.js**: データの処理ロジックを実装
- **fileService.js**: ファイル操作を担当
- **logService.js**: ログ関連の処理を実装

### 設定（config/）
- **constants.js**: エラーメッセージなどの定数を定義
- **paths.js**: ファイル出力先のパスを設定

## 5. APIエンドポイント

### データ関連
1. **POST /api/data**
   - 機能：新しいデータの受信と保存
   - リクエスト例：
     ```json
     {
       "患者氏名": "山田太郎",
       "患者氏名カナ": "ヤマダタロウ",
       "患者生年月日": "1990-01-01",
       "年齢": 33,
       "性別": "男性",
       "診療費税込": 5000,
       "検査キット金額合計税込": 2000,
       "薬金額合計税込": 3000,
       "合計金額税込": 10000,
       "合計金額税込加算減算後": 10000
     }
     ```
   - レスポンス例：
     ```json
     {
       "success": true,
       "message": "データを正常に受信し、ファイルに保存しました",
       "savedFiles": {
         "price": "PR-2025-02-08T12-30-45.json",
         "patient": "PT-2025-02-08T12-30-45.json"
       }
     }
     ```

2. **GET /api/latest**
   - 機能：最後に受信したデータの取得
   - レスポンス例：最後に受信したJSONデータ

3. **GET /api/logs**
   - 機能：システムログの取得
   - レスポンス例：
     ```json
     {
       "logs": [
         "[2025-02-08T03:52:36.609Z] [INFO] サーバーが起動しました",
         "[2025-02-08T03:53:15.132Z] [INFO] 新しいデータを受信しました"
       ]
     }
     ```

## 6. 使い方

1. **サーバーの起動**
   ```bash
   npm install    # 初回のみ
   npm start      # サーバー起動
   ```

2. **動作確認**
   - ブラウザで http://localhost:3000 にアクセス
   - データタブとログタブで情報を確認可能

3. **データの送信テスト（Postmanなどを使用）**
   - URL: http://localhost:3000/api/data
   - Method: POST
   - Header: Content-Type: application/json
   - Body: 上記のリクエスト例のJSONを使用

## 7. エラー処理

システムは以下のような場合にエラーを返します：
- 不正なJSONフォーマット
- ファイル保存の失敗
- ディレクトリ作成の失敗
- ログ操作の失敗

エラーが発生した場合は：
1. エラーログが記録されます
2. クライアントにエラー情報が返されます
3. Webインターフェースにエラーが表示されます