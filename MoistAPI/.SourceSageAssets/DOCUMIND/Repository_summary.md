# Project: project

```plaintext
OS: nt
Directory: C:\Users\aiba\Downloads\project-bolt-sb1-4erkckre (2)\project

â”œâ”€â”€ config/
â”‚   â””â”€â”€ kintone.js
â”œâ”€â”€ logs/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â””â”€â”€ appController.js
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ appRoutes.js
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ CacheService.js
â”‚   â”‚   â””â”€â”€ KintoneService.js
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ logger.js
â”œâ”€â”€ .env
â”œâ”€â”€ .SourceSageignore
â”œâ”€â”€ api-spec.md
â”œâ”€â”€ index.js
â””â”€â”€ package.json
```

## ðŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆ

- ðŸ“… ä½œæˆæ—¥æ™‚: 2025-02-23 22:14:10
- ðŸ“ ç·ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ•°: 7
- ðŸ“„ ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 11
- ðŸ“ æœ€å¤§æ·±åº¦: 2
- ðŸ“¦ æœ€å¤§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:  (18 ã‚¨ãƒ³ãƒˆãƒª)

### ðŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨è¡Œæ•°

| ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µã‚¤ã‚º | è¡Œæ•° | è¨€èªž |
|----------|--------|------|------|
| api-spec.md | 5.4 KB | 149 | markdown |
| src\controllers\appController.js | 4.2 KB | 133 | javascript |
| config\kintone.js | 3.0 KB | 64 | javascript |
| src\services\KintoneService.js | 2.3 KB | 88 | javascript |
| index.js | 1.8 KB | 67 | javascript |
| src\utils\logger.js | 1.4 KB | 53 | javascript |
| src\services\CacheService.js | 1.2 KB | 43 | javascript |
| .SourceSageignore | 745.0 B | 54 | plaintext |
| src\routes\appRoutes.js | 496.0 B | 13 | javascript |
| package.json | 290.0 B | 14 | json |
| .env | 108.0 B | 3 | plaintext |
| **åˆè¨ˆ** |  | **681** |  |

### ðŸ“ˆ è¨€èªžåˆ¥çµ±è¨ˆ

| è¨€èªž | ãƒ•ã‚¡ã‚¤ãƒ«æ•° | ç·è¡Œæ•° | åˆè¨ˆã‚µã‚¤ã‚º |
|------|------------|--------|------------|
| javascript | 7 | 461 | 14.4 KB |
| markdown | 1 | 149 | 5.4 KB |
| plaintext | 2 | 57 | 853.0 B |
| json | 1 | 14 | 290.0 B |

`.SourceSageignore`

**ã‚µã‚¤ã‚º**: 745.0 B | **è¡Œæ•°**: 54 è¡Œ
```plaintext
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é–¢é€£
.git/
.gitignore

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«
__pycache__/
.pytest_cache/
**/__pycache__/**
*.pyc

# ãƒ“ãƒ«ãƒ‰ãƒ»é…å¸ƒé–¢é€£
build/
dist/
*.egg-info/

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»å‡ºåŠ›
output/
output.md
test_output/
.SourceSageAssets/
.SourceSageAssetsDemo/

# ã‚¢ã‚»ãƒƒãƒˆ
*.png
*.svg
*.jpg
*.jepg
assets/

# ãã®ä»–
LICENSE
example/
package-lock.json
.DS_Store

# ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é™¤å¤–
tests/temp/
docs/drafts/

# ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¾‹å¤–ï¼ˆé™¤å¤–å¯¾è±¡ã‹ã‚‰é™¤å¤–ï¼‰
!docs/important.md
!.github/workflows/
repository_summary.md

# Terraformé–¢é€£
.terraform
*.terraform.lock.hcl
*.backup
*.tfstate

# Pythonä»®æƒ³ç’°å¢ƒ
venv
.venv
```

`.env`

**ã‚µã‚¤ã‚º**: 108.0 B | **è¡Œæ•°**: 3 è¡Œ
```plaintext
KINTONE_DOMAIN=8ue38.cybozu.com
KINTONE_API_TOKEN=0a0W6WHEQsu36WUrchgLvavgAR3WQWB9UlPV9FzM
KINTONE_APP_ID=76
```

`api-spec.md`

**ã‚µã‚¤ã‚º**: 5.4 KB | **è¡Œæ•°**: 149 è¡Œ
```markdown
# Kintone API é€£æºä»•æ§˜æ›¸

## **1. æ¦‚è¦**
Kintone API ã‚’åˆ©ç”¨ã—ã¦ã€æ‚£è€…æƒ…å ±ã€ä¼šè¨ˆæƒ…å ±ã€æ˜Žç´°æƒ…å ±ã®å–å¾—ã‚’è¡Œã†ãŸã‚ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚
æœ¬ API ã¯ JSON å½¢å¼ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æŽ¡ç”¨ã—ã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

## **2. APIä¸€è¦§**

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ           | æ©Ÿèƒ½ |
|----------|------------------|----------------------|
| POST     | /getRecordNumbers | Kintoneã‹ã‚‰æ‚£è€…æƒ…å ±ã‚’å–å¾—ã™ã‚‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼‰ |
| GET      | /price            | ä¼šè¨ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰ |
| GET      | /details          | æ˜Žç´°æƒ…å ±ã‚’å–å¾—ã™ã‚‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰ |
| POST     | /updatePaymentStatus | æ±ºæ¸ˆç¢ºèªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã™ã‚‹ |


## **3. APIä»•æ§˜**

### **3.1. Kintoneãƒ‡ãƒ¼ã‚¿å–å¾—API**
#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**
`POST /getRecordNumbers`

#### **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆJSONå½¢å¼ï¼‰**
| é …ç›®å | ãƒ‡ãƒ¼ã‚¿åž‹ | å¿…é ˆ | èª¬æ˜Ž |
|--------|--------|------|------|
| phoneNumber | str | â—‹ | æ‚£è€…é›»è©±ç•ªå· |

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆJSONå½¢å¼ï¼‰**
| é …ç›®å | ãƒ‡ãƒ¼ã‚¿åž‹ | èª¬æ˜Ž |
|--------|--------|------|
| success | bool | å‡¦ç†æˆåŠŸæ™‚ã¯ `true` |
| recordCount | int | å–å¾—ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰æ•° |
| error | str | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| details | object | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è©³ç´°æƒ…å ±ï¼ˆKintone APIã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰ |

---

### **3.2. ä¼šè¨ˆæƒ…å ±å–å¾—API**
#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**
`GET /price`

#### **ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**
| é …ç›®å | ãƒ‡ãƒ¼ã‚¿åž‹ | å¿…é ˆ | èª¬æ˜Ž |
|--------|--------|------|------|
| phoneNumber | str | â—‹ | æ‚£è€…é›»è©±ç•ªå· |

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆJSONå½¢å¼ï¼‰**
| é …ç›®å | ãƒ‡ãƒ¼ã‚¿åž‹ | èª¬æ˜Ž |
|--------|--------|------|
| æ‚£è€…é›»è©±ç•ªå· | str | æ‚£è€…ã®é›»è©±ç•ªå· |
| æ‚£è€…æ°å | str | æ‚£è€…ã®åå‰ |
| æ‚£è€…æ°åã‚«ãƒŠ | str | æ‚£è€…ã®ãƒ•ãƒªã‚¬ãƒŠ |
| ãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå· | str | è¨ºç™‚ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ID |
| è¨ºç™‚å®Ÿæ–½æ—¥ | str | è¨ºç™‚ãŒè¡Œã‚ã‚ŒãŸæ—¥ä»˜ |
| æ¤œæŸ»ã‚­ãƒƒãƒˆä¾¡æ ¼åˆè¨ˆç¨Žè¾¼ | str | æ¤œæŸ»ã‚­ãƒƒãƒˆã®ç¨Žè¾¼ä¾¡æ ¼ |
| è–¬ä¾¡æ ¼åˆè¨ˆç¨Žè¾¼ | str | è–¬ã®ç¨Žè¾¼ä¾¡æ ¼ |
| åˆè¨ˆé‡‘é¡ç¨Žè¾¼åŠ ç®—æ¸›ç®—å¾Œ | str | æœ€çµ‚çš„ãªç¨Žè¾¼ä¾¡æ ¼ |

---

### **3.3. æ˜Žç´°æƒ…å ±å–å¾—API**
#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**
`GET /details`

#### **ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**
| é …ç›®å | ãƒ‡ãƒ¼ã‚¿åž‹ | å¿…é ˆ | èª¬æ˜Ž |
|--------|--------|------|------|
| phoneNumber | str | â—‹ | æ‚£è€…é›»è©±ç•ªå· |

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆJSONå½¢å¼ï¼‰**
| é …ç›®å | ãƒ‡ãƒ¼ã‚¿åž‹ | èª¬æ˜Ž |
|--------|--------|------|
| æ‚£è€…é›»è©±ç•ªå· | str | æ‚£è€…ã®é›»è©±ç•ªå· |
| æ‚£è€…æ°å | str | æ‚£è€…ã®åå‰ |
| æ‚£è€…æ°åã‚«ãƒŠ | str | æ‚£è€…ã®ãƒ•ãƒªã‚¬ãƒŠ |
| è–¬å•†å“å | str | è–¬ã®åç§° |
| è–¬æ•°é‡ | str | è–¬ã®æ•°é‡ |
| æ¤œæŸ»ã‚­ãƒƒãƒˆãƒ—ãƒ©ãƒ³å | str | æ¤œæŸ»ã‚­ãƒƒãƒˆã®ãƒ—ãƒ©ãƒ³å |
| æ¤œæŸ»ã‚­ãƒƒãƒˆæ•°é‡ | str | æ¤œæŸ»ã‚­ãƒƒãƒˆã®æ•°é‡ |

---

### **3.4. æ±ºæ¸ˆç¢ºèªæ›´æ–°API**
#### **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**
`POST /updatePaymentStatus`

#### **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆJSONå½¢å¼ï¼‰**
| é …ç›®å | ãƒ‡ãƒ¼ã‚¿åž‹ | å¿…é ˆ | èª¬æ˜Ž |
|--------|--------|------|------|
| phoneNumber | str | â—‹ | æ‚£è€…é›»è©±ç•ªå· |
| recordId | str | â—‹ | æ›´æ–°å¯¾è±¡ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå· |

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆJSONå½¢å¼ï¼‰**
| é …ç›®å | ãƒ‡ãƒ¼ã‚¿åž‹ | èª¬æ˜Ž |
|--------|--------|------|
| success | bool | å‡¦ç†æˆåŠŸæ™‚ã¯ `true` |
| message | str | å‡¦ç†çµæžœã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| error | str | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| details | object | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è©³ç´°æƒ…å ± |

---

## **4. ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**

### **4.1. ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ | èª¬æ˜Ž |
|---------------|------|
| 400 | ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼‰ |
| 404 | ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã¾ãš /getRecordNumbers ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ï¼‰ |
| 500 | Kintoneã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ |

### **4.2. ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**
```json
{
  "error": "ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãš /getRecordNumbers ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€‚"
}
```

```json
{
  "error": "Failed to fetch records from Kintone",
  "details": {
    // Kintone APIã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  }
}
```

## **5. ä½¿ç”¨ä¸Šã®æ³¨æ„**

1. APIã®ä½¿ç”¨é †åº
   - å¿…ãšæœ€åˆã« `/getRecordNumbers` ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„
   - ãã®å¾Œã€ä»–ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™
   - `/getRecordNumbers` ã‚’å‘¼ã³å‡ºã•ãšã«ä»–ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã¨404ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã¾ã™

2. ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
   - ãƒ‡ãƒ¼ã‚¿ã¯ã‚µãƒ¼ãƒãƒ¼ãƒ¡ãƒ¢ãƒªä¸Šã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã™
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯é›»è©±ç•ªå·ã‚’ã‚­ãƒ¼ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™
   - ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™

3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
   - ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é›»è©±ç•ªå·ã¯å¿…é ˆã§ã™
   - é›»è©±ç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯400ã‚¨ãƒ©ãƒ¼
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯404ã‚¨ãƒ©ãƒ¼
   - Kintone APIã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯500ã‚¨ãƒ©ãƒ¼

4. ãƒ‡ãƒ¼ã‚¿å½¢å¼
   - ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯JSONå½¢å¼
   - æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã‚‚æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã•ã‚Œã¾ã™
   - æ—¥ä»˜ã¯Kintoneã®å½¢å¼ã®ã¾ã¾æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã•ã‚Œã¾ã™
```

`index.js`

**ã‚µã‚¤ã‚º**: 1.8 KB | **è¡Œæ•°**: 67 è¡Œ
```javascript
require('dotenv').config();
const express = require('express');
const KintoneService = require('./src/services/KintoneService');
const CacheService = require('./src/services/CacheService');
const AppController = require('./src/controllers/appController');
const setupRoutes = require('./src/routes/appRoutes');
const logger = require('./src/utils/logger');
const path = require('path');
const fs = require('fs');

class App {
  constructor() {
    this.app = express();
    this.port = 3000;
    this.setupLogsDirectory();
    this.setupMiddleware();
    this.setupServices();
    this.setupRoutes();
  }

  setupLogsDirectory() {
    const logsDir = path.join(__dirname, 'logs');
    if (!fs.existsSync(logsDir)) {
      fs.mkdirSync(logsDir);
    }
  }

  setupMiddleware() {
    this.app.use(express.json());
    this.app.use((req, res, next) => {
      logger.info(`${req.method} ${req.url}`, {
        query: req.query,
        body: req.body
      });
      next();
    });
  }

  setupServices() {
    this.kintoneService = new KintoneService();
    this.cacheService = new CacheService();
    this.appController = new AppController(
      this.kintoneService,
      this.cacheService
    );
  }

  setupRoutes() {
    const appController = this.appController;
    const routes = setupRoutes(appController);
    this.app.use('/', routes);
  }

  start() {
    this.app.listen(this.port, () => {
      logger.info(`Server running at http://localhost:${this.port}`);
      logger.info('Available endpoints:');
      logger.info('- POST /getRecordNumbers - Initial data fetch with patient info');
      logger.info('- GET /price - Get price information');
      logger.info('- GET /details - Get detailed information');
      logger.info('- POST /updatePaymentStatus - Update payment confirmation status');
    });
  }
}

const app = new App();
app.start();
```

`package.json`

**ã‚µã‚¤ã‚º**: 290.0 B | **è¡Œæ•°**: 14 è¡Œ
```json
{
  "name": "kintone-api-integration",
  "private": true,
  "scripts": {
    "start": "node index.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "dependencies": {
    "express": "^4.18.2",
    "axios": "^1.6.2",
    "dotenv": "^16.3.1",
    "winston": "^3.11.0"
  }
}
```

`config\kintone.js`

**ã‚µã‚¤ã‚º**: 3.0 KB | **è¡Œæ•°**: 64 è¡Œ
```javascript
// Kintoneã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®å®šç¾©
const FIELD_CODES = {
  PHONE_NUMBER: 'æ‚£è€…é›»è©±ç•ªå·',
  PATIENT_NAME: 'æ‚£è€…æ°å',
  PATIENT_NAME_KANA: 'æ‚£è€…æ°åã‚«ãƒŠ',
  RECORD_NUMBER: '$id',
  TREATMENT_DATE: 'è¨ºç™‚å®Ÿæ–½æ—¥',
  KIT_PRICE_WITH_TAX: 'æ¤œæŸ»ã‚­ãƒƒãƒˆä¾¡æ ¼åˆè¨ˆç¨Žè¾¼',
  MEDICINE_PRICE_WITH_TAX: 'è–¬ä¾¡æ ¼åˆè¨ˆç¨Žè¾¼',
  TOTAL_PRICE_WITH_TAX: 'åˆè¨ˆé‡‘é¡ç¨Žè¾¼åŠ ç®—æ¸›ç®—å¾Œ',
  MEDICINE_NAME: 'è–¬å•†å“å',
  MEDICINE_QUANTITY: 'è–¬æ•°é‡',
  KIT_PLAN_NAME: 'æ¤œæŸ»ã‚­ãƒƒãƒˆãƒ—ãƒ©ãƒ³å',
  KIT_QUANTITY: 'æ¤œæŸ»ã‚­ãƒƒãƒˆæ•°é‡',
  PAYMENT_STATUS: 'æ±ºæ¸ˆç¢ºèª',
  PAYMENT_METHOD: 'æ”¯æ‰•ã„æ–¹æ³•',
  BIRTH_DATE: 'æ‚£è€…ç”Ÿå¹´æœˆæ—¥',
  BIOLOGICAL_SEX: 'è¨ºç™‚_æ€§æ„ŸæŸ“ç—‡_ç”Ÿç‰©å­¦çš„ãªæ€§åˆ¥'
};

// ã‚¯ã‚¨ãƒªç”Ÿæˆé–¢æ•°
const generateQuery = (phoneNumber, limit, offset) => {
  return `${FIELD_CODES.PHONE_NUMBER} = "${phoneNumber}" and ${FIELD_CODES.PAYMENT_STATUS} not in ("ç¢ºèªæ¸ˆã¿") and ${FIELD_CODES.PAYMENT_METHOD} in ("ç¾åœ°ï¼ˆç²¾ç®—æ©Ÿï¼‰") limit ${limit} offset ${offset}`;
};

// ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒžãƒƒãƒ”ãƒ³ã‚°é–¢æ•°
const mapRecordToPrice = (record) => ({
  [FIELD_CODES.PHONE_NUMBER]: record[FIELD_CODES.PHONE_NUMBER]?.value || '',
  [FIELD_CODES.PATIENT_NAME]: record[FIELD_CODES.PATIENT_NAME]?.value || '',
  [FIELD_CODES.PATIENT_NAME_KANA]: record[FIELD_CODES.PATIENT_NAME_KANA]?.value || '',
  ãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå·: record[FIELD_CODES.RECORD_NUMBER]?.value || '',
  [FIELD_CODES.TREATMENT_DATE]: record[FIELD_CODES.TREATMENT_DATE]?.value || '',
  [FIELD_CODES.KIT_PRICE_WITH_TAX]: record[FIELD_CODES.KIT_PRICE_WITH_TAX]?.value || '',
  [FIELD_CODES.MEDICINE_PRICE_WITH_TAX]: record[FIELD_CODES.MEDICINE_PRICE_WITH_TAX]?.value || '',
  [FIELD_CODES.TOTAL_PRICE_WITH_TAX]: record[FIELD_CODES.TOTAL_PRICE_WITH_TAX]?.value || ''
});

const mapRecordToDetails = (record) => ({
  [FIELD_CODES.PHONE_NUMBER]: record[FIELD_CODES.PHONE_NUMBER]?.value || '',
  [FIELD_CODES.PATIENT_NAME]: record[FIELD_CODES.PATIENT_NAME]?.value || '',
  [FIELD_CODES.PATIENT_NAME_KANA]: record[FIELD_CODES.PATIENT_NAME_KANA]?.value || '',
  ãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå·: record[FIELD_CODES.RECORD_NUMBER]?.value || '',
  [FIELD_CODES.TREATMENT_DATE]: record[FIELD_CODES.TREATMENT_DATE]?.value || '',
  [FIELD_CODES.MEDICINE_NAME]: record[FIELD_CODES.MEDICINE_NAME]?.value || '',
  [FIELD_CODES.MEDICINE_QUANTITY]: record[FIELD_CODES.MEDICINE_QUANTITY]?.value || '',
  [FIELD_CODES.KIT_PLAN_NAME]: record[FIELD_CODES.KIT_PLAN_NAME]?.value || '',
  [FIELD_CODES.KIT_QUANTITY]: record[FIELD_CODES.KIT_QUANTITY]?.value || ''
});

const mapRecordToPatientInfo = (record) => ({
  [FIELD_CODES.PHONE_NUMBER]: record[FIELD_CODES.PHONE_NUMBER]?.value || '',
  [FIELD_CODES.PATIENT_NAME]: record[FIELD_CODES.PATIENT_NAME]?.value || '',
  [FIELD_CODES.PATIENT_NAME_KANA]: record[FIELD_CODES.PATIENT_NAME_KANA]?.value || '',
  [FIELD_CODES.BIRTH_DATE]: record[FIELD_CODES.BIRTH_DATE]?.value || '',
  [FIELD_CODES.BIOLOGICAL_SEX]: record[FIELD_CODES.BIOLOGICAL_SEX]?.value || ''
});

module.exports = {
  FIELD_CODES,
  generateQuery,
  mapRecordToPrice,
  mapRecordToDetails,
  mapRecordToPatientInfo
};
```

`src\controllers\appController.js`

**ã‚µã‚¤ã‚º**: 4.2 KB | **è¡Œæ•°**: 133 è¡Œ
```javascript
const logger = require('../utils/logger');

class AppController {
  constructor(kintoneService, cacheService) {
    this.kintoneService = kintoneService;
    this.cacheService = cacheService;
  }

  async getRecordNumbers(req, res) {
    const phoneNumber = req.body.phoneNumber;

    if (!phoneNumber) {
      logger.error('Missing phone number in request');
      return res.status(400).json({
        error: 'æ‚£è€…é›»è©±ç•ªå·ãŒå¿…è¦ã§ã™',
      });
    }

    try {
      logger.info(`Fetching records for phone number: ${phoneNumber}`);
      const allRecords = await this.kintoneService.fetchRecords(phoneNumber);
      this.cacheService.setCacheData(phoneNumber, allRecords);
      const patientInfo = this.cacheService.getPatientInfo(allRecords);

      logger.info(`Successfully fetched ${allRecords.length} records for ${phoneNumber}`);
      res.json({
        success: true,
        recordCount: allRecords.length,
        patient: patientInfo,
      });
    } catch (error) {
      logger.error('Error fetching records:', {
        phoneNumber,
        error: error.response?.data || error.message,
        stack: error.stack
      });
      res.status(500).json({
        error: 'Failed to fetch records from Kintone',
        details: error.response?.data || error.message,
      });
    }
  }

  async updatePaymentStatus(req, res) {
    const { phoneNumber, recordId } = req.body;

    if (!phoneNumber || !recordId) {
      logger.error('Missing required parameters', { phoneNumber, recordId });
      return res.status(400).json({
        error: 'æ‚£è€…é›»è©±ç•ªå·ã¨ãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå·ãŒå¿…è¦ã§ã™',
      });
    }

    // ãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå·ã®æ¤œè¨¼
    if (!this.cacheService.validateRecordId(phoneNumber, recordId)) {
      logger.error('Invalid record ID or cache not found', { phoneNumber, recordId });
      return res.status(400).json({
        error: 'ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå·ã¯ç„¡åŠ¹ã§ã™ã€‚ã¾ãš /getRecordNumbers ã‚’å‘¼ã³å‡ºã—ã¦æœ‰åŠ¹ãªãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå·ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚',
      });
    }

    try {
      logger.info(`Updating payment status for record: ${recordId}`);
      await this.kintoneService.updatePaymentStatus(recordId);
      
      // æ›´æ–°ãŒæˆåŠŸã—ãŸã‚‰ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è©²å½“æ‚£è€…ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      this.cacheService.removeCacheData(phoneNumber);
      logger.info(`Successfully updated payment status and removed cache for ${phoneNumber}`);

      res.json({
        success: true,
        message: 'æ±ºæ¸ˆç¢ºèªã‚’æ›´æ–°ã—ã¾ã—ãŸ',
      });
    } catch (error) {
      logger.error('Error updating payment status:', {
        phoneNumber,
        recordId,
        error: error.response?.data || error.message,
        stack: error.stack
      });
      res.status(500).json({
        error: 'Failed to update record in Kintone',
        details: error.response?.data || error.message,
      });
    }
  }

  getPrice(req, res) {
    const phoneNumber = req.query.phoneNumber;

    if (!phoneNumber) {
      logger.error('Missing phone number in price request');
      return res.status(400).json({
        error: 'æ‚£è€…é›»è©±ç•ªå·ãŒå¿…è¦ã§ã™',
      });
    }

    const cachedData = this.cacheService.getCacheData(phoneNumber);
    if (!cachedData) {
      logger.error(`Cache miss for phone number: ${phoneNumber}`);
      return res.status(404).json({
        error: 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãš /getRecordNumbers ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€‚',
      });
    }

    logger.info(`Successfully retrieved price data for ${phoneNumber}`);
    res.json(cachedData.price);
  }

  getDetails(req, res) {
    const phoneNumber = req.query.phoneNumber;

    if (!phoneNumber) {
      logger.error('Missing phone number in details request');
      return res.status(400).json({
        error: 'æ‚£è€…é›»è©±ç•ªå·ãŒå¿…è¦ã§ã™',
      });
    }

    const cachedData = this.cacheService.getCacheData(phoneNumber);
    if (!cachedData) {
      logger.error(`Cache miss for phone number: ${phoneNumber}`);
      return res.status(404).json({
        error: 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãš /getRecordNumbers ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€‚',
      });
    }

    logger.info(`Successfully retrieved details data for ${phoneNumber}`);
    res.json(cachedData.details);
  }
}

module.exports = AppController;
```

`src\routes\appRoutes.js`

**ã‚µã‚¤ã‚º**: 496.0 B | **è¡Œæ•°**: 13 è¡Œ
```javascript
const express = require('express');
const router = express.Router();

function setupRoutes(appController) {
  router.post('/getRecordNumbers', (req, res) => appController.getRecordNumbers(req, res));
  router.post('/updatePaymentStatus', (req, res) => appController.updatePaymentStatus(req, res));
  router.get('/price', (req, res) => appController.getPrice(req, res));
  router.get('/details', (req, res) => appController.getDetails(req, res));

  return router;
}

module.exports = setupRoutes;
```

`src\services\CacheService.js`

**ã‚µã‚¤ã‚º**: 1.2 KB | **è¡Œæ•°**: 43 è¡Œ
```javascript
const { mapRecordToPrice, mapRecordToDetails, mapRecordToPatientInfo } = require('../../config/kintone');
const logger = require('../utils/logger');

class CacheService {
  constructor() {
    this.cache = new Map();
  }

  setCacheData(phoneNumber, records) {
    this.cache.set(phoneNumber, {
      rawRecords: records,
      price: records.map(mapRecordToPrice),
      details: records.map(mapRecordToDetails),
      recordIds: records.map(record => record.$id.value)
    });
    logger.info(`Cache updated for phone number: ${phoneNumber}`);
  }

  getCacheData(phoneNumber) {
    const data = this.cache.get(phoneNumber);
    logger.info(`Cache ${data ? 'hit' : 'miss'} for phone number: ${phoneNumber}`);
    return data;
  }

  removeCacheData(phoneNumber) {
    this.cache.delete(phoneNumber);
    logger.info(`Cache removed for phone number: ${phoneNumber}`);
  }

  getPatientInfo(records) {
    return records.length > 0 ? mapRecordToPatientInfo(records[0]) : {};
  }

  validateRecordId(phoneNumber, recordId) {
    const data = this.getCacheData(phoneNumber);
    if (!data) {
      return false;
    }
    return data.recordIds.includes(recordId);
  }
}

module.exports = CacheService;
```

`src\services\KintoneService.js`

**ã‚µã‚¤ã‚º**: 2.3 KB | **è¡Œæ•°**: 88 è¡Œ
```javascript
const axios = require('axios');
const { FIELD_CODES, generateQuery } = require('../../config/kintone');
const logger = require('../utils/logger');

class KintoneService {
  constructor() {
    this.domain = process.env.KINTONE_DOMAIN;
    this.apiToken = process.env.KINTONE_API_TOKEN;
    this.appId = process.env.KINTONE_APP_ID;

    if (!this.domain || !this.apiToken || !this.appId) {
      logger.error('Missing required Kintone configuration');
      throw new Error('Missing required Kintone configuration');
    }
  }

  async fetchRecords(phoneNumber) {
    let allRecords = [];
    let offset = 0;
    const limit = 100;

    while (true) {
      try {
        const query = generateQuery(phoneNumber, limit, offset);
        const response = await axios({
          method: 'get',
          url: `https://${this.domain}/k/v1/records.json`,
          headers: {
            'X-Cybozu-API-Token': this.apiToken,
          },
          params: {
            app: this.appId,
            query: query,
          },
        });

        const records = response.data.records;
        if (records.length === 0) break;

        allRecords = allRecords.concat(records);
        offset += limit;

        if (records.length < limit) break;
      } catch (error) {
        logger.error('Error fetching records from Kintone:', {
          phoneNumber,
          offset,
          error: error.response?.data || error.message
        });
        throw error;
      }
    }

    return allRecords;
  }

  async updatePaymentStatus(recordId) {
    try {
      const response = await axios({
        method: 'put',
        url: `https://${this.domain}/k/v1/record.json`,
        headers: {
          'X-Cybozu-API-Token': this.apiToken,
          'Content-Type': 'application/json'
        },
        data: {
          app: this.appId,
          id: recordId,
          record: {
            [FIELD_CODES.PAYMENT_STATUS]: {
              value: ["ç¢ºèªæ¸ˆã¿"]
            }
          }
        }
      });
      logger.info(`Successfully updated payment status for record: ${recordId}`);
      return response.data;
    } catch (error) {
      logger.error('Error updating payment status in Kintone:', {
        recordId,
        error: error.response?.data || error.message
      });
      throw error;
    }
  }
}

module.exports = KintoneService;
```

`src\utils\logger.js`

**ã‚µã‚¤ã‚º**: 1.4 KB | **è¡Œæ•°**: 53 è¡Œ
```javascript
const winston = require('winston');
const path = require('path');

// æ—¥æœ¬æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆé–¢æ•°
const japanTimeFormat = winston.format((info) => {
  const japanTime = new Date(info.timestamp || Date.now()).toLocaleString('ja-JP', {
    timeZone: 'Asia/Tokyo',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  info.timestamp = japanTime;
  return info;
});

// ã‚·ãƒ³ãƒ—ãƒ«ãªä¸€è¡Œãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
const singleLineFormat = winston.format.printf(({ timestamp, level, message, ...meta }) => {
  const metaStr = Object.keys(meta).length ? ` ${JSON.stringify(meta)}` : '';
  return `${timestamp} [${level.toUpperCase()}] ${message}${metaStr}`;
});

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    japanTimeFormat(),
    singleLineFormat
  ),
  transports: [
    new winston.transports.File({ 
      filename: path.join(__dirname, '../../logs/error.log'), 
      level: 'error' 
    }),
    new winston.transports.File({ 
      filename: path.join(__dirname, '../../logs/combined.log')
    })
  ]
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.combine(
      winston.format.timestamp(),
      japanTimeFormat(),
      singleLineFormat
    )
  }));
}

module.exports = logger;
```

