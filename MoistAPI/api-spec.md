# Kintone API 連携仕様書

## **1. 概要**
Kintone API を利用して、患者情報、会計情報、明細情報の取得を行うためのエンドポイントを提供します。
本 API は JSON 形式でのリクエスト・レスポンスを採用し、データ取得のパフォーマンス向上のためキャッシュを利用しています。

## **2. API一覧**

| メソッド | エンドポイント           | 機能 |
|----------|------------------|----------------------|
| POST     | /getRecordNumbers | Kintoneから患者情報を取得する（キャッシュに保存） |
| GET      | /price            | 会計情報を取得する（キャッシュ利用） |
| GET      | /details          | 明細情報を取得する（キャッシュ利用） |
| POST     | /updatePaymentStatus | 決済確認ステータスを更新する （キャッシュクリア）|

## **3. API仕様**

### **3.1. Kintoneデータ取得API**
#### **エンドポイント**
`POST /getRecordNumbers`

#### **リクエストパラメータ（JSON形式）**
| 項目名 | データ型 | 必須 | 説明 |
|--------|--------|------|------|
| phoneNumber | str | ○ | 患者電話番号 |

#### **レスポンス（JSON形式）**
| 項目名 | データ型 | 説明 |
|--------|--------|------|
| success | bool | 処理成功時は `true` |
| recordCount | int | 取得したレコード数 |
| error | str | エラー発生時のメッセージ |
| details | object | エラー発生時の詳細情報（Kintone APIからのエラーレスポンス） |

---

### **3.2. 会計情報取得API**
#### **エンドポイント**
`GET /price`

#### **クエリパラメータ**
| 項目名 | データ型 | 必須 | 説明 |
|--------|--------|------|------|
| phoneNumber | str | ○ | 患者電話番号 |

#### **レスポンス（JSON形式）**
| 項目名 | データ型 | 説明 |
|--------|--------|------|
| 患者電話番号 | str | 患者の電話番号 |
| 患者氏名 | str | 患者の名前 |
| 患者氏名カナ | str | 患者のフリガナ |
| レコード番号 | str | 診療のレコードID |
| 診療実施日 | str | 診療が行われた日付 |
| 検査キット価格合計税込 | str | 検査キットの税込価格 |
| 薬価格合計税込 | str | 薬の税込価格 |
| 合計金額税込加算減算後 | str | 最終的な税込価格 |

---

### **3.3. 明細情報取得API**
#### **エンドポイント**
`GET /details`

#### **クエリパラメータ**
| 項目名 | データ型 | 必須 | 説明 |
|--------|--------|------|------|
| phoneNumber | str | ○ | 患者電話番号 |

#### **レスポンス（JSON形式）**
| 項目名 | データ型 | 説明 |
|--------|--------|------|
| 患者電話番号 | str | 患者の電話番号 |
| 患者氏名 | str | 患者の名前 |
| 患者氏名カナ | str | 患者のフリガナ |
| 薬商品名 | str | 薬の名称 |
| 薬数量 | str | 薬の数量 |
| 検査キットプラン名 | str | 検査キットのプラン名 |
| 検査キット数量 | str | 検査キットの数量 |

---

### **3.4. 決済確認更新API**
#### **エンドポイント**
`POST /updatePaymentStatus`

#### **リクエストパラメータ（JSON形式）**
| 項目名 | データ型 | 必須 | 説明 |
|--------|--------|------|------|
| phoneNumber | str | ○ | 患者電話番号 |
| recordId | str | ○ | 更新対象のレコード番号 |

#### **レスポンス（JSON形式）**
| 項目名 | データ型 | 説明 |
|--------|--------|------|
| success | bool | 処理成功時は `true` |
| message | str | 処理結果のメッセージ |
| error | str | エラー発生時のメッセージ |
| details | object | エラー発生時の詳細情報 |

---

## **4. エラーレスポンス**

### **4.1. エラー時のステータスコード**
| ステータスコード | 説明 |
|---------------|------|
| 400 | 不正なリクエスト（必須パラメータが不足しています） |
| 404 | データが見つかりません（まず /getRecordNumbers を呼び出してください） |
| 500 | Kintoneからのデータ取得に失敗しました |

### **4.2. エラーレスポンス例**
```json
{
  "error": "データが見つかりません。まず /getRecordNumbers を呼び出してください。"
}
```

```json
{
  "error": "Failed to fetch records from Kintone",
  "details": {
    // Kintone APIからのエラーレスポンス
  }
}
```

## **5. 使用上の注意**

1. APIの使用順序
   - 必ず最初に `/getRecordNumbers` を呼び出してください
   - その後、他のエンドポイントを呼び出すことができます
   - `/getRecordNumbers` を呼び出さずに他のエンドポイントを呼び出すと404エラーが返されます

2. データのキャッシュ
   - データはサーバーメモリ上にキャッシュされます
   - キャッシュは電話番号をキーとして保存されます

   ### **2.1. キャッシュのクリアタイミング**
   以下の場合にキャッシュがクリアされます：

   1. サーバー再起動時
      - アプリケーション再起動時に全てのキャッシュが消去されます
      - 再起動後は再度 `/getRecordNumbers` の呼び出しが必要です

   2. 決済確認更新時
      - `/updatePaymentStatus` APIの呼び出し成功時
      - 更新された患者の電話番号に紐づくキャッシュのみが削除されます
      - 他の患者のキャッシュには影響しません

   3. エラー発生時
      - Kintone APIとの通信エラー発生時
      - データ整合性が保証できない場合
      - エラーが発生した患者の電話番号に紐づくキャッシュのみが削除されます

   ### **2.2. キャッシュの再取得**
   キャッシュがクリアされた場合：
   - 再度 `/getRecordNumbers` を呼び出す必要があります
   - キャッシュが存在しない状態で他のAPIを呼び出すと404エラーが返されます
   - キャッシュの再取得は、最新のKintoneデータを取得するため必要な処理です

   ### **2.3. キャッシュの有効期限**
   - キャッシュに有効期限は設定されていません
   - 明示的なクリアタイミング以外はキャッシュが維持されます

3. エラーハンドリング
   - すべてのリクエストで電話番号は必須です
   - 電話番号が指定されていない場合は400エラー
   - キャッシュにデータが存在しない場合は404エラー
   - Kintone APIでエラーが発生した場合は500エラー

4. データ形式
   - すべてのリクエスト・レスポンスはJSON形式
   - 数値データも文字列として返されます
   - 日付はKintoneの形式のまま文字列として返されます

## **6. Postmanでの使用方法**

### **6.1. 環境設定**
1. 新しい環境を作成し、以下の変数を設定
   - `baseUrl`: `http://localhost:3000`
   - `phoneNumber`: テスト用電話番号（例：`"09012345678"`）

### **6.2. リクエスト例**

#### **患者情報取得（/getRecordNumbers）**
```
POST {{baseUrl}}/getRecordNumbers
Content-Type: application/json

{
    "phoneNumber": "{{phoneNumber}}"
}
```

#### **会計情報取得（/price）**
```
GET {{baseUrl}}/price?phoneNumber={{phoneNumber}}
```

#### **明細情報取得（/details）**
```
GET {{baseUrl}}/details?phoneNumber={{phoneNumber}}
```

#### **決済確認更新（/updatePaymentStatus）**
```
POST {{baseUrl}}/updatePaymentStatus
Content-Type: application/json

{
    "phoneNumber": "{{phoneNumber}}",
    "recordId": "取得したレコード番号"
}
```

## **7. ログ出力仕様**

### **7.1. ログ形式**
```
YYYY/MM/DD HH:mm:ss [LEVEL] メッセージ 追加情報
```

### **7.2. ログレベル**
- INFO: 通常の処理情報
- ERROR: エラー情報

### **7.3. 出力先**
- `logs/combined.log`: すべてのログ
- `logs/error.log`: エラーログのみ

### **7.4. 主なログ出力内容**

#### **サーバー起動時**
```
2025/02/23 21:54:32 [INFO] Server running at http://localhost:3000
2025/02/23 21:54:32 [INFO] Available endpoints:
```

#### **APIリクエスト時**
```
2025/02/23 21:54:32 [INFO] POST /getRecordNumbers {"query":{},"body":{"phoneNumber":"09012345678"}}
```

#### **キャッシュ操作時**
```
2025/02/23 21:54:32 [INFO] Cache updated for phone number: 09012345678
2025/02/23 21:54:32 [INFO] Cache hit for phone number: 09012345678
```

#### **エラー発生時**
```
2025/02/23 21:54:32 [ERROR] Error fetching records: {"phoneNumber":"09012345678","error":"Network Error"}
```