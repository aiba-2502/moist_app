# Kintone API 連携仕様書

## **1. 概要**
Kintone API を利用して、患者情報、会計情報、明細情報の取得を行うためのエンドポイントを提供します。
本 API は JSON 形式でのリクエスト・レスポンスを採用し、データ取得のパフォーマンス向上のためキャッシュを利用しています。

## **2. API一覧**

| メソッド | エンドポイント           | 機能 |
|----------|------------------|----------------------|
| POST     | /getRecordNumbers | Kintoneから患者情報を取得する（キャッシュに保存） |
| GET      | /price            | 会計情報を取得する（キャッシュ利用） |
| GET      | /details          | 明細情報を取得する（キャッシュ利用） |
| POST     | /updatePaymentStatus | 決済確認ステータスを更新する |


## **3. API仕様**

### **3.1. Kintoneデータ取得API**
#### **エンドポイント**
`POST /getRecordNumbers`

#### **リクエストパラメータ（JSON形式）**
| 項目名 | データ型 | 必須 | 説明 |
|--------|--------|------|------|
| phoneNumber | str | ○ | 患者電話番号 |

#### **レスポンス（JSON形式）**
| 項目名 | データ型 | 説明 |
|--------|--------|------|
| success | bool | 処理成功時は `true` |
| recordCount | int | 取得したレコード数 |
| error | str | エラー発生時のメッセージ |
| details | object | エラー発生時の詳細情報（Kintone APIからのエラーレスポンス） |

---

### **3.2. 会計情報取得API**
#### **エンドポイント**
`GET /price`

#### **クエリパラメータ**
| 項目名 | データ型 | 必須 | 説明 |
|--------|--------|------|------|
| phoneNumber | str | ○ | 患者電話番号 |

#### **レスポンス（JSON形式）**
| 項目名 | データ型 | 説明 |
|--------|--------|------|
| 患者電話番号 | str | 患者の電話番号 |
| 患者氏名 | str | 患者の名前 |
| 患者氏名カナ | str | 患者のフリガナ |
| レコード番号 | str | 診療のレコードID |
| 診療実施日 | str | 診療が行われた日付 |
| 検査キット価格合計税込 | str | 検査キットの税込価格 |
| 薬価格合計税込 | str | 薬の税込価格 |
| 合計金額税込加算減算後 | str | 最終的な税込価格 |

---

### **3.3. 明細情報取得API**
#### **エンドポイント**
`GET /details`

#### **クエリパラメータ**
| 項目名 | データ型 | 必須 | 説明 |
|--------|--------|------|------|
| phoneNumber | str | ○ | 患者電話番号 |

#### **レスポンス（JSON形式）**
| 項目名 | データ型 | 説明 |
|--------|--------|------|
| 患者電話番号 | str | 患者の電話番号 |
| 患者氏名 | str | 患者の名前 |
| 患者氏名カナ | str | 患者のフリガナ |
| 薬商品名 | str | 薬の名称 |
| 薬数量 | str | 薬の数量 |
| 検査キットプラン名 | str | 検査キットのプラン名 |
| 検査キット数量 | str | 検査キットの数量 |

---

### **3.4. 決済確認更新API**
#### **エンドポイント**
`POST /updatePaymentStatus`

#### **リクエストパラメータ（JSON形式）**
| 項目名 | データ型 | 必須 | 説明 |
|--------|--------|------|------|
| phoneNumber | str | ○ | 患者電話番号 |
| recordId | str | ○ | 更新対象のレコード番号 |

#### **レスポンス（JSON形式）**
| 項目名 | データ型 | 説明 |
|--------|--------|------|
| success | bool | 処理成功時は `true` |
| message | str | 処理結果のメッセージ |
| error | str | エラー発生時のメッセージ |
| details | object | エラー発生時の詳細情報 |

---

## **4. エラーレスポンス**

### **4.1. エラー時のステータスコード**
| ステータスコード | 説明 |
|---------------|------|
| 400 | 不正なリクエスト（必須パラメータが不足しています） |
| 404 | データが見つかりません（まず /getRecordNumbers を呼び出してください） |
| 500 | Kintoneからのデータ取得に失敗しました |

### **4.2. エラーレスポンス例**
```json
{
  "error": "データが見つかりません。まず /getRecordNumbers を呼び出してください。"
}
```

```json
{
  "error": "Failed to fetch records from Kintone",
  "details": {
    // Kintone APIからのエラーレスポンス
  }
}
```

## **5. 使用上の注意**

1. APIの使用順序
   - 必ず最初に `/getRecordNumbers` を呼び出してください
   - その後、他のエンドポイントを呼び出すことができます
   - `/getRecordNumbers` を呼び出さずに他のエンドポイントを呼び出すと404エラーが返されます

2. データのキャッシュ
   - データはサーバーメモリ上にキャッシュされます
   - キャッシュは電話番号をキーとして保存されます
   - サーバー再起動時にキャッシュはクリアされます

3. エラーハンドリング
   - すべてのリクエストで電話番号は必須です
   - 電話番号が指定されていない場合は400エラー
   - キャッシュにデータが存在しない場合は404エラー
   - Kintone APIでエラーが発生した場合は500エラー

4. データ形式
   - すべてのリクエスト・レスポンスはJSON形式
   - 数値データも文字列として返されます
   - 日付はKintoneの形式のまま文字列として返されます